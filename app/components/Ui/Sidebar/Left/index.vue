<template>
  <aside
    class="bg-neutral-100 overflow-hidden border border-l-0 my-1 rounded-tr-lg rounded-br-lg border-(--color-standard) shadow-lg bottom-0 top-0 left-0 fixed z-20 w-sm flex flex-col gap-4"
  >
    <h1 class="mt-8 px-6 text-(--color-lapis-950)">
      <svg
        width="234"
        height="23"
        viewBox="0 0 234 23"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M7.696 15.1918C8.85733 15.1918 9.776 14.6892 10.452 13.6838C11.128 12.6612 11.466 11.2485 11.466 9.44584C11.466 7.74717 11.128 6.42117 10.452 5.46784C9.776 4.51451 8.85733 4.03784 7.696 4.03784C6.53467 4.03784 5.616 4.51451 4.94 5.46784C4.264 6.42117 3.926 7.74717 3.926 9.44584C3.926 11.2485 4.264 12.6612 4.94 13.6838C5.616 14.6892 6.53467 15.1918 7.696 15.1918ZM13.286 22.7318C11.5007 22.7318 9.984 22.2898 8.736 21.4058C7.488 20.5392 6.56067 19.4472 5.954 18.1298C4.15133 17.7485 2.704 16.8038 1.612 15.2958C0.537333 13.7878 0 11.8378 0 9.44584C0 7.59117 0.320667 6.02251 0.962 4.73984C1.62067 3.43984 2.522 2.45184 3.666 1.77584C4.82733 1.08251 6.17067 0.73584 7.696 0.73584C9.22133 0.73584 10.556 1.08251 11.7 1.77584C12.8613 2.45184 13.7627 3.43984 14.404 4.73984C15.0627 6.03984 15.392 7.60851 15.392 9.44584C15.392 11.7165 14.9067 13.5972 13.936 15.0878C12.9653 16.5612 11.6567 17.5318 10.01 17.9998C10.4087 18.5892 10.946 19.0138 11.622 19.2738C12.3153 19.5338 13.0173 19.6638 13.728 19.6638C14.092 19.6638 14.43 19.6292 14.742 19.5598C15.0713 19.5078 15.3573 19.4472 15.6 19.3778L16.276 22.1598C15.964 22.3158 15.548 22.4458 15.028 22.5498C14.5253 22.6712 13.9447 22.7318 13.286 22.7318Z"
          fill="currentColor"
        />
        <path
          d="M18.3194 17.9998V1.04784H24.4294C25.6254 1.04784 26.7174 1.21251 27.7054 1.54184C28.6934 1.85384 29.4821 2.39117 30.0714 3.15384C30.6608 3.91651 30.9554 4.97384 30.9554 6.32584C30.9554 7.57384 30.6781 8.60517 30.1234 9.41984C29.5861 10.2172 28.8581 10.8152 27.9394 11.2138L31.7874 17.9998H27.4974L24.2474 11.8898H22.1414V17.9998H18.3194ZM22.1414 8.84784H24.1174C25.1228 8.84784 25.8854 8.63984 26.4054 8.22384C26.9428 7.79051 27.2114 7.15784 27.2114 6.32584C27.2114 5.49384 26.9428 4.91317 26.4054 4.58384C25.8854 4.25451 25.1228 4.08984 24.1174 4.08984H22.1414V8.84784Z"
          fill="currentColor"
        />
        <path
          d="M38.9498 17.9998V1.04784H49.6358V4.27184H42.7718V8.19784H48.6478V11.4218H42.7718V17.9998H38.9498Z"
          fill="currentColor"
        />
        <path
          d="M59.0066 18.3118C56.8053 18.3118 55.1239 17.6618 53.9626 16.3618C52.8013 15.0618 52.2206 12.9905 52.2206 10.1478V1.04784H56.0686V10.5378C56.0686 12.2018 56.3199 13.3632 56.8226 14.0218C57.3253 14.6805 58.0533 15.0098 59.0066 15.0098C59.9599 15.0098 60.6966 14.6805 61.2166 14.0218C61.7366 13.3632 61.9966 12.2018 61.9966 10.5378V1.04784H65.6886V10.1478C65.6886 12.9905 65.1166 15.0618 63.9726 16.3618C62.8459 17.6618 61.1906 18.3118 59.0066 18.3118Z"
          fill="currentColor"
        />
        <path
          d="M74.2757 18.3118C73.1664 18.3118 72.057 18.1038 70.9477 17.6878C69.8557 17.2718 68.8764 16.6652 68.0097 15.8678L70.1937 13.2418C70.8004 13.7618 71.4764 14.1865 72.2217 14.5158C72.967 14.8452 73.6864 15.0098 74.3797 15.0098C75.177 15.0098 75.7664 14.8625 76.1477 14.5678C76.5464 14.2732 76.7457 13.8745 76.7457 13.3718C76.7457 12.8345 76.5204 12.4445 76.0697 12.2018C75.6364 11.9418 75.047 11.6558 74.3017 11.3438L72.0917 10.4078C71.5197 10.1652 70.9737 9.84451 70.4537 9.44584C69.9337 9.02984 69.509 8.51851 69.1797 7.91184C68.8504 7.30517 68.6857 6.59451 68.6857 5.77984C68.6857 4.84384 68.937 3.99451 69.4397 3.23184C69.9597 2.46917 70.6704 1.86251 71.5717 1.41184C72.4904 0.961173 73.539 0.73584 74.7177 0.73584C75.6884 0.73584 76.659 0.926507 77.6297 1.30784C78.6004 1.68917 79.4497 2.24384 80.1777 2.97184L78.2277 5.38984C77.673 4.95651 77.1184 4.62717 76.5637 4.40184C76.009 4.15917 75.3937 4.03784 74.7177 4.03784C74.059 4.03784 73.5304 4.17651 73.1317 4.45384C72.7504 4.71384 72.5597 5.08651 72.5597 5.57184C72.5597 6.09184 72.8024 6.48184 73.2877 6.74184C73.7904 7.00184 74.4057 7.27917 75.1337 7.57384L77.3177 8.45784C78.3404 8.87384 79.155 9.44584 79.7617 10.1738C80.3684 10.9018 80.6717 11.8638 80.6717 13.0598C80.6717 13.9958 80.4204 14.8625 79.9177 15.6598C79.415 16.4572 78.687 17.0985 77.7337 17.5838C76.7804 18.0692 75.6277 18.3118 74.2757 18.3118Z"
          fill="currentColor"
        />
        <path
          d="M83.289 17.9998V1.04784H87.111V17.9998H83.289Z"
          fill="currentColor"
        />
        <path
          d="M108.363 17.9998V1.04784H112.289L116.709 9.47184L118.373 13.2158H118.477C118.407 12.3145 118.312 11.3092 118.191 10.1998C118.069 9.09051 118.009 8.03317 118.009 7.02784V1.04784H121.649V17.9998H117.723L113.303 9.54984L111.639 5.85784H111.535C111.621 6.79384 111.717 7.79917 111.821 8.87384C111.942 9.94851 112.003 10.9885 112.003 11.9938V17.9998H108.363Z"
          fill="currentColor"
        />
        <path
          d="M130.339 17.9998V1.04784H134.525L137.255 8.58784C137.428 9.07317 137.593 9.58451 137.749 10.1218C137.905 10.6592 138.069 11.1878 138.243 11.7078H138.347C138.52 11.1878 138.676 10.6592 138.815 10.1218C138.971 9.58451 139.135 9.07317 139.309 8.58784L141.987 1.04784H146.147V17.9998H142.663V11.7858C142.663 11.2312 142.689 10.6158 142.741 9.93984C142.81 9.24651 142.879 8.55317 142.949 7.85984C143.035 7.16651 143.105 6.55117 143.157 6.01384H143.053L141.675 10.0438L139.257 16.5178H137.151L134.733 10.0438L133.381 6.01384H133.277C133.346 6.55117 133.415 7.16651 133.485 7.85984C133.554 8.55317 133.615 9.24651 133.667 9.93984C133.736 10.6158 133.771 11.2312 133.771 11.7858V17.9998H130.339Z"
          fill="currentColor"
        />
        <path
          d="M153.861 9.41984L153.445 10.9798H157.059L156.669 9.41984C156.444 8.57051 156.21 7.66917 155.967 6.71584C155.742 5.76251 155.517 4.84384 155.292 3.95984H155.188C154.98 4.86117 154.763 5.78851 154.538 6.74184C154.33 7.67784 154.104 8.57051 153.861 9.41984ZM147.725 17.9998L153.029 1.04784H157.632L162.936 17.9998H158.88L157.839 13.9698H152.665L151.626 17.9998H147.725Z"
          fill="currentColor"
        />
        <path
          d="M169.702 18.3118C168.592 18.3118 167.483 18.1038 166.374 17.6878C165.282 17.2718 164.302 16.6652 163.436 15.8678L165.62 13.2418C166.226 13.7618 166.902 14.1865 167.648 14.5158C168.393 14.8452 169.112 15.0098 169.806 15.0098C170.603 15.0098 171.192 14.8625 171.574 14.5678C171.972 14.2732 172.172 13.8745 172.172 13.3718C172.172 12.8345 171.946 12.4445 171.496 12.2018C171.062 11.9418 170.473 11.6558 169.728 11.3438L167.518 10.4078C166.946 10.1652 166.4 9.84451 165.88 9.44584C165.36 9.02984 164.935 8.51851 164.606 7.91184C164.276 7.30517 164.112 6.59451 164.112 5.77984C164.112 4.84384 164.363 3.99451 164.866 3.23184C165.386 2.46917 166.096 1.86251 166.998 1.41184C167.916 0.961173 168.965 0.73584 170.144 0.73584C171.114 0.73584 172.085 0.926507 173.056 1.30784C174.026 1.68917 174.876 2.24384 175.604 2.97184L173.654 5.38984C173.099 4.95651 172.544 4.62717 171.99 4.40184C171.435 4.15917 170.82 4.03784 170.144 4.03784C169.485 4.03784 168.956 4.17651 168.558 4.45384C168.176 4.71384 167.986 5.08651 167.986 5.57184C167.986 6.09184 168.228 6.48184 168.714 6.74184C169.216 7.00184 169.832 7.27917 170.56 7.57384L172.744 8.45784C173.766 8.87384 174.581 9.44584 175.188 10.1738C175.794 10.9018 176.098 11.8638 176.098 13.0598C176.098 13.9958 175.846 14.8625 175.344 15.6598C174.841 16.4572 174.113 17.0985 173.16 17.5838C172.206 18.0692 171.054 18.3118 169.702 18.3118Z"
          fill="currentColor"
        />
        <path
          d="M181.509 17.9998V4.27184H176.855V1.04784H190.011V4.27184H185.357V17.9998H181.509Z"
          fill="currentColor"
        />
        <path
          d="M192.395 17.9998V1.04784H203.003V4.27184H196.217V7.67784H201.989V10.8758H196.217V14.7758H203.263V17.9998H192.395Z"
          fill="currentColor"
        />
        <path
          d="M206.379 17.9998V1.04784H212.489C213.685 1.04784 214.777 1.21251 215.765 1.54184C216.753 1.85384 217.541 2.39117 218.131 3.15384C218.72 3.91651 219.015 4.97384 219.015 6.32584C219.015 7.57384 218.737 8.60517 218.183 9.41984C217.645 10.2172 216.917 10.8152 215.999 11.2138L219.847 17.9998H215.557L212.307 11.8898H210.201V17.9998H206.379ZM210.201 8.84784H212.177C213.182 8.84784 213.945 8.63984 214.465 8.22384C215.002 7.79051 215.271 7.15784 215.271 6.32584C215.271 5.49384 215.002 4.91317 214.465 4.58384C213.945 4.25451 213.182 4.08984 212.177 4.08984H210.201V8.84784Z"
          fill="currentColor"
        />
        <path
          d="M226.882 18.3118C225.773 18.3118 224.664 18.1038 223.554 17.6878C222.462 17.2718 221.483 16.6652 220.617 15.8678L222.8 13.2418C223.407 13.7618 224.083 14.1865 224.828 14.5158C225.574 14.8452 226.293 15.0098 226.986 15.0098C227.784 15.0098 228.373 14.8625 228.755 14.5678C229.153 14.2732 229.352 13.8745 229.352 13.3718C229.352 12.8345 229.127 12.4445 228.676 12.2018C228.243 11.9418 227.654 11.6558 226.908 11.3438L224.699 10.4078C224.126 10.1652 223.581 9.84451 223.061 9.44584C222.54 9.02984 222.116 8.51851 221.786 7.91184C221.457 7.30517 221.292 6.59451 221.292 5.77984C221.292 4.84384 221.544 3.99451 222.046 3.23184C222.566 2.46917 223.277 1.86251 224.178 1.41184C225.097 0.961173 226.146 0.73584 227.324 0.73584C228.295 0.73584 229.266 0.926507 230.236 1.30784C231.207 1.68917 232.057 2.24384 232.785 2.97184L230.835 5.38984C230.28 4.95651 229.725 4.62717 229.171 4.40184C228.616 4.15917 228 4.03784 227.324 4.03784C226.666 4.03784 226.137 4.17651 225.738 4.45384C225.357 4.71384 225.167 5.08651 225.167 5.57184C225.167 6.09184 225.409 6.48184 225.895 6.74184C226.397 7.00184 227.012 7.27917 227.74 7.57384L229.924 8.45784C230.947 8.87384 231.762 9.44584 232.368 10.1738C232.975 10.9018 233.279 11.8638 233.279 13.0598C233.279 13.9958 233.027 14.8625 232.524 15.6598C232.022 16.4572 231.294 17.0985 230.34 17.5838C229.387 18.0692 228.234 18.3118 226.882 18.3118Z"
          fill="currentColor"
        />
        <path
          fill-rule="evenodd"
          clip-rule="evenodd"
          d="M97.224 19C98.0613 19 98.8044 17.4975 99.2694 15.1769C99.7139 16.7701 100.347 17.7662 101.05 17.7662C102.395 17.7662 103.485 14.1206 103.485 9.62338C103.485 5.12615 102.395 1.48052 101.05 1.48052C100.362 1.48052 99.7409 2.4347 99.2981 3.96893C98.8352 1.56566 98.0787 0 97.224 0C95.8153 0 94.6733 4.25329 94.6733 9.5C94.6733 14.7467 95.8153 19 97.224 19ZM98.6153 9.62338C98.6153 8.19004 98.726 6.84321 98.9205 5.67333C98.6535 4.48861 98.2645 3.74238 97.8314 3.74238C97.0264 3.74238 96.3738 6.32014 96.3738 9.49996C96.3738 12.6798 97.0264 15.2575 97.8314 15.2575C98.2519 15.2575 98.6309 14.5539 98.8969 13.4285C98.7171 12.2928 98.6153 10.9979 98.6153 9.62338ZM103.021 9.62338C103.021 12.349 102.398 14.5584 101.63 14.5584C100.861 14.5584 100.238 12.349 100.238 9.62338C100.238 6.89777 100.861 4.68831 101.63 4.68831C102.398 4.68831 103.021 6.89777 103.021 9.62338Z"
          fill="currentColor"
        />
        <path
          d="M105.108 12.0909C105.492 12.0909 105.804 10.9862 105.804 9.62338C105.804 8.2606 105.492 7.15584 105.108 7.15584C104.724 7.15584 104.412 8.2606 104.412 9.62338C104.412 10.9862 104.724 12.0909 105.108 12.0909Z"
          fill="currentColor"
        />
        <path
          d="M92.1226 9.6235C92.1226 12.7427 93.077 15.5323 94.5777 17.3882C91.8098 16.3452 89.8037 13.2633 89.8037 9.6235C89.8037 5.98365 91.8098 2.90176 94.5777 1.85884C93.077 3.71467 92.1226 6.50426 92.1226 9.6235Z"
          fill="currentColor"
        />
      </svg>
    </h1>
    <div class="space-y-6 overflow-auto py-6 h-full px-6 mt-6">
      <div>
        <ElInput
          v-model="config.url"
          name="url"
          label="Text / URL"
          type="text"
        />
      </div>
      <div
        v-if="!config.colors.codeBackgroundGradientEnabled"
        class="border border-(--color-standard) p-4 rounded-lg"
      >
        <ElInputSwitch
          v-model="config.initialTransparentCode"
          name="initialTransparentCode"
          label="Make QR code on initial load transparent"
        />
      </div>
      <div class="text-base font-bold uppercase">Color Configuration</div>
      <div>
        <ElInputSelect
          v-model="selectedColorMode"
          :items="[
            {
              label: 'Solid',
              value: 'solid',
            },
            {
              label: 'Gradient',
              value: 'gradient',
            },
          ]"
        />
      </div>
      <template v-if="config.colors.codeBackgroundGradientEnabled">
        <div>
          <ElInputSwitch
            v-model="config.colors.codeBackgroundGradientPredefined"
            name="codeBackgroundGradientPredefined"
            label="Enable Predefined Gradient Color"
          />
        </div>
        <template v-if="!config.colors.codeBackgroundGradientPredefined">
          <div>
            <ElInputSwitch
              v-model="config.colors.codeBackgroundGradientAnimate"
              name="codeBackgroundGradientAnimate"
              label="Enable Animations for Gradient Color"
            />
          </div>
          <div>
            <ElInput
              v-model="config.colors.codeBackgroundGradientDegree"
              name="codeBackgroundGradientDegree"
              label="Gradient Code Degree"
              type="number"
              :min="0"
              :max="360"
            />
          </div>
          <div
            v-for="(palette, paletteIndex) in config.colors
              .codeBackgroundGradientPalette"
            :key="paletteIndex"
            class="flex items-center gap-2"
          >
            <ElInputColor
              v-model="
                config.colors.codeBackgroundGradientPalette[paletteIndex]
              "
              class="flex-1"
              :data-palette="palette"
            >
              Color #{{ paletteIndex + 1 }}
            </ElInputColor>
            <ElButton
              v-if="
                paletteIndex ===
                config.colors.codeBackgroundGradientPalette.length - 1
              "
              variant="secondary"
              class="uppercase !flex items-center justify-center !size-10"
              @click="
                config.colors.codeBackgroundGradientPalette.push('rgb(0, 0, 0)')
              "
            >
              <Icon name="mdi:add" size="22" />
            </ElButton>
            <ElButton
              v-if="config.colors.codeBackgroundGradientPalette.length > 1"
              variant="error"
              class="uppercase !flex items-center justify-center !size-10"
              @click="
                config.colors.codeBackgroundGradientPalette.splice(
                  paletteIndex,
                  1,
                )
              "
            >
              <Icon name="mdi:trash" size="22" />
            </ElButton>
          </div>
        </template>
      </template>
      <template v-if="!config.colors.codeBackgroundGradientEnabled">
        <div>
          <ElInputSwitch
            v-model="config.colors.random"
            name="colorsRandom"
            label="Enable Random Colors"
          />
        </div>
        <div v-if="selectedTheme !== ETheme.background">
          <ElInputColor v-model="config.colors.codeBackgroundColor"
            >Background color</ElInputColor
          >
        </div>
        <div v-if="!config.colors.random">
          <ElInputColors />
        </div>
      </template>
    </div>
    <div class="p-4 space-y-2">
      <template v-if="!config.colors.codeBackgroundGradientEnabled">
        <div class="border border-(--color-standard) p-4 rounded-lg">
          <div class="space-y-4">
            <ElInputSwitch
              v-model="config.animation.enabled"
              name="animationEnabled"
              label="Auto generate new version"
            />
            <template v-if="isAnimationEnabled">
              <div class="space-y-1">
                <div class="text-sm font-medium">Mode</div>
                <span class="flex flex-wrap gap-2">
                  <ElButton
                    class="capitalize"
                    inline
                    variant="text"
                    :active="config.animation.mode === 'instant'"
                    @click="config.animation.mode = 'instant'"
                  >
                    Instant
                  </ElButton>

                  <ElButton
                    class="capitalize"
                    inline
                    variant="text"
                    :active="config.animation.mode === 'ease-in'"
                    @click="config.animation.mode = 'ease-in'"
                  >
                    Ease In
                  </ElButton>
                </span>
              </div>
              <div v-if="config.animation.mode === 'ease-in'" class="space-y-1">
                <div class="text-sm font-medium">
                  Speed ({{ config.animation.speed }}ms)
                </div>
                <input
                  v-model="config.animation.speed"
                  class="w-full"
                  type="range"
                  step="1"
                  min="1"
                  max="100"
                />
              </div>
            </template>
            <div v-else-if="config.colors.selected?.length > 1">
              <ElButton variant="secondary" @click="onInit">
                Generate new version
              </ElButton>
            </div>
          </div>
        </div>
      </template>
    </div>
  </aside>
  <Teleport to="body">
    <div
      v-if="isScannable !== null"
      class="fixed top-4 left-0 right-0 flex justify-center w-full z-50"
    >
      <div
        class="text-(--color-lapis-950) w-sm text-lg py-3 px-6 border text-center font-semibold rounded-lg shadow-lg"
        :class="{
          'bg-green-100 border-green-500': isScannable,
          'bg-red-100 border-red-500': !isScannable,
        }"
      >
        <template v-if="isScannable">QR Code is scannable!</template>
        <template v-else>QR Code is <strong>not</strong> scannable</template>
      </div>
    </div>
  </Teleport>
  <Teleport to="body">
    <div class="fixed bottom-0 left-0 right-0 z-10 flex justify-center">
      <div
        class="shadow-lg bg-neutral-100 border border-(--color-standard) rounded-full mb-4 h-12 px-4 flex items-center"
      >
        <ElInputSwitch
          v-model="config.darkMode"
          name="darkMode"
          label="Dark Mode"
        />
      </div>
    </div>
  </Teleport>
</template>

<script lang="ts" setup>
import { ETheme } from "~/composables/useConfig";

const { onInit } = useCode();

const { config, isAnimationEnabled, selectedTheme } = useConfig();
const isScannable = ref<boolean | null>(null);

const selectedColorMode = ref(
  config.value.colors.codeBackgroundGradientEnabled ? "gradient" : "solid",
);

watch(selectedColorMode, (_selectedColorMode) => {
  config.value.colors.codeBackgroundGradientEnabled =
    _selectedColorMode === "gradient";
});

useIntervalFn(async () => {
  if (selectedTheme.value === ETheme.background) {
    isScannable.value = null;
  } else {
    await onCheckIfCodeIsScannable();
  }
}, 5000);

const onCheckIfCodeIsScannable = async () => {
  const el = document.getElementById("qr_code_container");
  const svgElement = el?.children[0]?.children[0] as SVGElement | null;

  if (svgElement instanceof SVGElement) {
    try {
      const isValid = await isQRCodeScannable(svgElement);
      isScannable.value = !!isValid;
      console.log(
        isValid ? "QR Code is scannable!" : "QR Code is not scannable!",
      );
    } catch (error) {
      console.error("Error checking if QR code is scannable:", error);
    }
  } else {
    console.log("QR code container or SVG element not found");
  }
};
</script>
